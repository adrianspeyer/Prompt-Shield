<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PromptShield ‚Äì Advanced AI Detection & Encoding Tool</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; padding: 20px; }
    #debug { white-space: pre-wrap; color: red; margin-bottom: 10px; }
    textarea { width: 100%; height: 200px; font-size: 14px; padding: 10px; }
    button { padding: 10px 20px; margin: 10px 5px 0 0; font-size: 16px; cursor: pointer; }
    #output, #results { background: #fff; padding: 15px; margin-top: 20px; border: 1px solid #ccc; border-radius: 5px; white-space: pre-wrap; }
    #spinner { display: none; margin-top: 10px; }
    canvas { margin-top: 20px; background: #fff; border: 1px solid #ccc; border-radius: 5px; }
    #controls { margin-top: 10px; }
    label { font-size: 14px; margin-right: 10px; }
  </style>
</head>
<body onload="updateStrictnessDisplay()">

  <!-- Debug console -->
  <div id="debug">JS debug output will appear here</div>

  <h1>PromptShield ‚Äì Advanced AI Detection & Encoding Tool</h1>
  <div id="controls">
    <button onclick="switchMode('encode')">Encode Instructions</button>
    <button onclick="switchMode('detect')">Detect AI Content</button>
    <label>
      Strictness:
      <input id="strictnessSlider" type="range" min="0.5" max="2" step="0.1" value="1"
             oninput="updateStrictnessDisplay()">
      <span id="strictnessValue">1.0</span>x
    </label>
  </div>

  <div id="encodeMode">
    <h2>Encode Teacher Instructions</h2>
    <textarea id="encodeInput" placeholder="Paste your instructions..."></textarea><br>
    <button onclick="encodeText()">Encode</button>
    <button onclick="copyOutput()">Copy to Clipboard</button>
    <div id="output"></div>
  </div>

  <div id="detectMode" style="display:none;">
    <h2>Detect AI Usage</h2>
    <textarea id="detectInput" placeholder="Paste student content..."></textarea><br>
    <button onclick="startDetection()">Analyze</button>
    <button onclick="clearDetect()">Clear</button>
    <button onclick="exportReport()">Export Report</button>
    <div id="spinner">üîÑ Analyzing...</div>
    <div id="results"></div>
    <canvas id="scoreChart" width="800" height="600"></canvas>
  </div>

  <script>
    // Global error handler
    window.onerror = function(message, source, lineno, colno, error) {
      const debug = document.getElementById('debug');
      debug.textContent += `Error: ${message} at ${source}:${lineno}:${colno}\n`;
      return true;  // prevent console error
    };
    window.onunhandledrejection = function(evt) {
      document.getElementById('debug').textContent +=
        `Promise reject: ${evt.reason}\n`;
    };

    // ---- Utilities ----
    function normalizeText(text) {
      return text.replace(/[‚Äú‚Äù]/g,'"')
                 .replace(/[‚Äò‚Äô]/g,"'")
                 .replace(/‚Äî/g,'-')
                 .replace(/&[a-z]+;/gi,'')
                 .trim();
    }
    function randomWatermark() {
      const chars = ['\u200B','\u200C','\u200D','\u2060'];
      let seq = '';
      const len = 5 + Math.floor(Math.random()*10);
      for (let i=0; i<len; i++) seq += chars[Math.floor(Math.random()*chars.length)];
      return seq;
    }
    function countSyllables(w) {
      w=w.toLowerCase();
      if(w.length<=3) return 1;
      const m=w.match(/[aeiouy]{1,2}/g);
      return m?m.length:1;
    }
    function fleschKincaid(txt) {
      const sents=(txt.match(/[^.!?]+[.!?]/g)||[]).length;
      const ws=txt.split(/\s+/);
      const syl=ws.reduce((a,w)=>a+countSyllables(w),0);
      const ASL=sents?ws.length/sents:0;
      const ASW=ws.length?syl/ws.length:0;
      return 0.39*ASL + 11.8*ASW - 15.59;
    }
    function sentimentVariance(pars) {
      const pos=['good','great','positive','strong','effective','successful','important'];
      const neg=['weak','bad','problem','issue','difficult','fail','collapse'];
      const scores=pars.map(p=>{
        const ws=p.toLowerCase().split(/\W+/);
        let s=0; ws.forEach(w=>{ if(pos.includes(w)) s++; if(neg.includes(w)) s--; });
        return ws.length?s/ws.length:0;
      });
      if(scores.length<2) return 1;
      const m=scores.reduce((a,b)=>a+b,0)/scores.length;
      return scores.reduce((a,b)=>a+(b-m)**2,0)/scores.length;
    }

    // ---- Configurable Weights ----
    const WEIGHTS = {
      Watermark: 5,
      FewContractions: 2,
      RepetitiveStructures: 4.5,
      ExcessiveTransitions: 2,
      UniformParagraphs: 2,
      NoPersonalVoice: 2,
      NumericDensity: 2,
      OpinionInsertion: 1.5,
      RhetoricalQuestions: 2,
      ReadabilityScore: 1.5,
      LowLexicalDiversity: 1.5,
      PassiveVoice: 1.5,
      NgramRepetition: 1.5,
      SentimentUniformity: 1.5,
      HedgeWords: 1.5,
      EmojiUsage: 1.5,
      ComplexPunctuation: 1.5
    };

    // ---- Detection Rules ----
    let watermark = randomWatermark();
    const RULES = [
      { key:'Watermark',            test:t=>t.includes(watermark),        msg:'üíß Watermark detected.' },
      { key:'FewContractions',      test:t=>(t.match(/\b(I‚Äôm|don‚Äôt|can‚Äôt|won‚Äôt|isn‚Äôt|aren‚Äôt)\b/gi)||[]).length<4,   msg:'üö´ Few contractions' },
      { key:'RepetitiveStructures', test:t=>(t.match(/\b(One major reason|Another cause|A third reason|In conclusion)\b/gi)||[]).length>2, msg:'üîÅ Repetitive structure' },
      { key:'ExcessiveTransitions', test:t=>(t.match(/\b(Furthermore|Moreover|Thus|Besides|Finally|Therefore|Additionally|In summary)\b/gi)||[]).length>3, msg:'üåÄ Excessive transitions' },
      { key:'UniformParagraphs',     test:t=>{ const ps=t.split(/\n+/).filter(p=>p.trim()), ls=ps.map(p=>p.split(/\s+/).length), avg=ls.reduce((a,b)=>a+b,0)/ls.length; return ls.length>2&&ls.every(l=>Math.abs(l-avg)<10); }, msg:'üìè Uniform paragraphs' },
      { key:'NoPersonalVoice',      test:t=>(t.match(/\b(I|we|my|our|you|your)\b/gi)||[]).length<2,                  msg:'üôÖ‚Äç‚ôÇÔ∏è No personal voice' },
      { key:'NumericDensity',       test:t=>{const nums=t.match(/\b\d+(\.\d+)?%?\b/g)||[];return nums.length>t.split(/\s+/).length*0.03;}, msg:'üî¢ High numeric density' },
      { key:'OpinionInsertion',     test:t=>(t.match(/\b(In my opinion|I believe|I think|It is important to note)\b/gi)||[]).length>0, msg:'üó£Ô∏è Opinion insertion' },
      { key:'RhetoricalQuestions',  test:t=>(t.match(/\?\s/g)||[]).length<1,                                    msg:'‚ùì No questions' },
      { key:'ReadabilityScore',     test:t=>{const fk=fleschKincaid(t);return fk>35&&fk<60;},                    msg:'üìê Readability range' },
      { key:'LowLexicalDiversity',  test:t=>{const ws=t.split(/\s+/),uw=new Set(ws.map(w=>w.toLowerCase()));return uw.size/ws.length<0.4;}, msg:'üìä Low diversity' },
      { key:'PassiveVoice',         test:t=>(t.match(/\b(is|was|were|been|being)\b\s+\w+ed\b/g)||[]).length>2,      msg:'üé≠ Passive voice' },
      { key:'NgramRepetition',      test:t=>{const ws=t.split(/\s+/),tr={};for(let i=0;i<ws.length-2;i++){const g=ws[i]+' '+ws[i+1]+' '+ws[i+2];tr[g]=(tr[g]||0)+1;if(tr[g]>2)return true;}return false;}, msg:'üîÇ N-gram repetition' },
      { key:'SentimentUniformity',  test:t=>{const ps=t.split(/\n+/).filter(p=>p.trim());return sentimentVariance(ps)<0.002;}, msg:'‚öñÔ∏è Uniform sentiment' },
      { key:'HedgeWords',           test:t=>(t.match(/\b(possibly|potentially|arguably|perhaps|somewhat)\b/gi)||[]).length>3, msg:'üîç Hedge words' },
      { key:'EmojiUsage',           test:t=>(t.match(/[üòÄ-üôè]/g)||[]).length>1,                                  msg:'üòä Emoji usage' },
      { key:'ComplexPunctuation',   test:t=>(t.match(/[;:,]/g)||[]).length>5,                                   msg:'‚úçÔ∏è Complex punctuation usage' }
    ];

    let reportData = {};

    // ---- UI Helpers ----
    function updateStrictnessDisplay() {
      document.getElementById('strictnessValue').innerText =
        document.getElementById('strictnessSlider').value;
    }
    function switchMode(mode) {
      document.getElementById('encodeMode').style.display =
        mode==='encode'?'block':'none';
      document.getElementById('detectMode').style.display =
        mode==='detect'?'block':'none';
    }

    // ---- Encoding ----
    function encodeText() {
      watermark = randomWatermark();
      const t = document.getElementById('encodeInput').value;
      document.getElementById('output').innerText =
        watermark + "\n\n" + t + "\n\n" + watermark;
    }
    function copyOutput() {
      navigator.clipboard.writeText(
        document.getElementById('output').innerText
      ).then(()=>alert('Copied!'));
    }

    // ---- Detection ----
    function startDetection() {
      document.getElementById('spinner').style.display='block';
      setTimeout(detectAI,50);
    }
    function detectAI() {
      const raw = document.getElementById('detectInput').value;
      const txt = normalizeText(raw);
      document.getElementById('spinner').style.display='none';
      const ws = txt.split(/\s+/).filter(w=>w);
      if(ws.length<50){
        document.getElementById('results').innerText='Not enough data'; return;
      }
      const strict = parseFloat(
        document.getElementById('strictnessSlider').value
      );
      let score=0,m=[],d=[];
      RULES.forEach(r=>{
        if(r.test(txt)){
          const w = WEIGHTS[r.key]*strict;
          score+=w; m.push(r.msg); d.push({name:r.key,value:w});
        }
      });
      const finalScore=Math.min(10,score).toFixed(1),
            like= score>5?'High':'Moderate';
      reportData={score:finalScore,likelihood:like,details:d};
      document.getElementById('results').innerHTML=
        `<strong>AI Score: ${finalScore}/10</strong><br>`+
        `<strong>Likely:</strong> ${like}`+
        `<ul><li>${m.join('</li><li>')}</li></ul>`;
      const cctx = document.getElementById('scoreChart').getContext('2d');
      cctx.clearRect(0,0,800,600);
      d.forEach((f,i)=>{
        cctx.fillStyle='#4a90e2';
        cctx.fillRect(200,i*40+20,f.value*40,25);
        cctx.fillStyle='#000';
        cctx.fillText(f.name+': '+f.value.toFixed(1),10,i*40+35);
      });
    }
    function clearDetect() {
      document.getElementById('detectInput').value='';
      document.getElementById('results').innerHTML='';
      document.getElementById('scoreChart').getContext('2d')
        .clearRect(0,0,800,600);
    }
    function exportReport() {
      const blob=new Blob([JSON.stringify(reportData,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='report.json'; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
