<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PromptShield ‚Äì Advanced AI Detection & Encoding Tool</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; padding: 20px; }
    textarea { width: 100%; height: 200px; font-size: 14px; padding: 10px; }
    button { padding: 10px 20px; margin: 10px 5px 0 0; font-size: 16px; cursor: pointer; }
    #output, #results { background: #fff; padding: 15px; margin-top: 20px; border: 1px solid #ccc; border-radius: 5px; white-space: pre-wrap; }
    #spinner { display: none; margin-top: 10px; }
    canvas { margin-top: 20px; background: #fff; border: 1px solid #ccc; border-radius: 5px; }
    #controls { margin-top: 10px; }
    label { font-size: 14px; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>PromptShield ‚Äì Advanced AI Detection & Encoding Tool</h1>

  <div id="controls">
    <button id="encodeTab">Encode Instructions</button>
    <button id="detectTab">Detect AI Content</button>
    <label>
      Strictness:
      <input id="strictnessSlider" type="range" min="0.5" max="2" step="0.1" value="1">
      <span id="strictnessValue">1.0</span>x
    </label>
  </div>

  <div id="encodeSection">
    <h2>Encode Teacher Instructions</h2>
    <textarea id="encodeInput" placeholder="Paste your instructions..."></textarea><br>
    <button id="encodeRun">Encode</button>
    <button id="encodeCopy">Copy to Clipboard</button>
    <div id="output"></div>
  </div>

  <div id="detectSection" style="display:none;">
    <h2>Detect AI Usage</h2>
    <textarea id="detectInput" placeholder="Paste student content..."></textarea><br>
    <button id="analyzeRun">Analyze</button>
    <button id="detectClear">Clear</button>
    <button id="detectExport">Export Report</button>
    <div id="spinner">üîÑ Analyzing...</div>
    <div id="results"></div>
    <canvas id="chart" width="800" height="600"></canvas>
  </div>

  <script>
    window.onload = function() {
      // Elements
      var encodeTab = document.getElementById('encodeTab');
      var detectTab = document.getElementById('detectTab');
      var encodeSection = document.getElementById('encodeSection');
      var detectSection = document.getElementById('detectSection');
      var strictSlider = document.getElementById('strictnessSlider');
      var strictValue = document.getElementById('strictnessValue');
      var encodeRun = document.getElementById('encodeRun');
      var encodeCopy = document.getElementById('encodeCopy');
      var output = document.getElementById('output');
      var analyzeRun = document.getElementById('analyzeRun');
      var detectClear = document.getElementById('detectClear');
      var detectExport = document.getElementById('detectExport');
      var spinner = document.getElementById('spinner');
      var results = document.getElementById('results');
      var chart = document.getElementById('chart').getContext('2d');
      var watermark = '';

      // Tab switching
      encodeTab.onclick = function() {
        encodeSection.style.display = 'block';
        detectSection.style.display = 'none';
      };
      detectTab.onclick = function() {
        encodeSection.style.display = 'none';
        detectSection.style.display = 'block';
      };

      // Strictness display
      strictValue.textContent = strictSlider.value;
      strictSlider.oninput = function() {
        strictValue.textContent = this.value;
      };

      // Utilities
      function randomWatermark() {
        var chars = ['\u200B','\u200C','\u200D','\u2060'];
        var seq = '';
        var len = 5 + Math.floor(Math.random()*10);
        for (var i=0; i<len; i++) {
          seq += chars[Math.floor(Math.random()*chars.length)];
        }
        return seq;
      }

      // Encode logic
      encodeRun.onclick = function() {
        watermark = randomWatermark();
        var text = document.getElementById('encodeInput').value;
        output.innerText = watermark + "\n\n" + text + "\n\n" + watermark;
      };
      encodeCopy.onclick = function() {
        navigator.clipboard.writeText(output.innerText).then(function(){
          alert('Copied!');
        });
      };

      // Detection helpers
      function countSyllables(w) {
        w = w.toLowerCase();
        if (w.length <= 3) return 1;
        var m = w.match(/[aeiouy]{1,2}/g);
        return m ? m.length : 1;
      }
      function fleschKincaid(txt) {
        var sents = (txt.match(/[^.!?]+[.!?]/g)||[]).length;
        var ws = txt.split(/\s+/);
        var syl = ws.reduce(function(a,w){return a+countSyllables(w);},0);
        var ASL = sents ? ws.length/sents : 0;
        var ASW = ws.length ? syl/ws.length : 0;
        return 0.39*ASL + 11.8*ASW - 15.59;
      }
      function sentimentVariance(pars) {
        var pos=['good','great','positive','strong','effective','successful','important'];
        var neg=['weak','bad','problem','issue','difficult','fail','collapse'];
        var sc = pars.map(function(p){
          var ws = p.toLowerCase().split(/\W+/);
          var s=0; ws.forEach(function(w){ if(pos.indexOf(w)>-1) s++; if(neg.indexOf(w)>-1) s--; });
          return ws.length ? s/ws.length : 0;
        });
        if (sc.length<2) return 1;
        var mean = sc.reduce(function(a,b){return a+b;},0)/sc.length;
        return sc.reduce(function(a,b){return a+(b-mean)*(b-mean);},0)/sc.length;
      }

      // ---- Configurable Weights ----
      var WEIGHTS = {
        Watermark: 5,
        FewContractions: 2,
        RepetitiveStructures: 4.5,
        ExcessiveTransitions: 2,
        UniformParagraphs: 2,
        NoPersonalVoice: 2,
        NumericDensity: 2,
        OpinionInsertion: 1.5,
        RhetoricalQuestions: 2,
        ReadabilityScore: 1.5,
        LowLexicalDiversity: 1.5,
        PassiveVoice: 1.5,
        NgramRepetition: 1.5,
        SentimentUniformity: 1.5,
        HedgeWords: 1.5,
        EmojiUsage: 1.5,
        ComplexPunctuation: 1.5
      };

      // ---- Detection Rules ----
      var RULES = [
        {name:'Watermark', key:'Watermark', test:function(t){return t.includes(watermark);}, msg:'üíß Watermark detected.'},
        {name:'Few Contractions', key:'FewContractions', test:function(t){return (t.match(/\b(I‚Äôm|don‚Äôt|can‚Äôt|won‚Äôt|isn‚Äôt|aren‚Äôt)\b/gi)||[]).length<4;}, msg:'üö´ Few contractions'},
        {name:'Repetitive Structures', key:'RepetitiveStructures', test:function(t){return (t.match(/\b(One major reason|Another important cause|A third reason|In conclusion)\b/gi)||[]).length>2;}, msg:'üîÅ Repetitive structure'},
        {name:'Excessive Transitions', key:'ExcessiveTransitions', test:function(t){return (t.match(/\b(Furthermore|Moreover|Thus|Besides|Finally|Therefore|Additionally|In summary)\b/gi)||[]).length>3;}, msg:'üåÄ Excessive transitions'},
        {name:'Uniform Paragraphs', key:'UniformParagraphs', test:function(t){
            var ps=t.split(/\n+/).filter(function(p){return p.trim();});
            var ls=ps.map(function(p){return p.split(/\s+/).length;});
            var avg=ls.reduce(function(a,b){return a+b;},0)/ls.length;
            return ls.length>2 && ls.every(function(l){return Math.abs(l-avg)<10;});
          }, msg:'üìè Uniform paragraphs'},
        {name:'No Personal Voice', key:'NoPersonalVoice', test:function(t){return (t.match(/\b(I|we|my|our|you|your)\b/gi)||[]).length<2;}, msg:'üôÖ‚Äç‚ôÇÔ∏è No personal voice'},
        {name:'Numeric Density', key:'NumericDensity', test:function(t){
            var nums=t.match(/\b\d+(\.\d+)?%?\b/g)||[];
            return nums.length> t.split(/\s+/).length*0.03;
          }, msg:'üî¢ High numeric density'},
        {name:'Opinion Insertion', key:'OpinionInsertion', test:function(t){return (t.match(/\b(In my opinion|I believe|I think|It is important to note)\b/gi)||[]).length>0;}, msg:'üó£Ô∏è Opinion insertion'},
        {name:'Rhetorical Questions', key:'RhetoricalQuestions', test:function(t){return (t.match(/\?\s/g)||[]).length<1;}, msg:'‚ùì No questions'},
        {name:'Readability Score', key:'ReadabilityScore', test:function(t){var fk=fleschKincaid(t);return fk>35&&fk<60;}, msg:'üìê Readability range'},
        {name:'Low Lexical Diversity', key:'LowLexicalDiversity', test:function(t){
            var ws=t.split(/\s+/), uw=new Set(ws.map(function(w){return w.toLowerCase();}));
            return uw.size/ws.length<0.4;
          }, msg:'üìä Low diversity'},
        {name:'Passive Voice', key:'PassiveVoice', test:function(t){return (t.match(/\b(is|was|were|been|being)\b\s+\w+ed\b/g)||[]).length>2;}, msg:'üé≠ Passive voice'},
        {name:'N-gram Repetition', key:'NgramRepetition', test:function(t){
            var ws=t.split(/\s+/), tr={};
            for(var i=0;i<ws.length-2;i++){
              var g=ws[i]+' '+ws[i+1]+' '+ws[i+2];
              tr[g]=(tr[g]||0)+1;
              if(tr[g]>2) return true;
            }
            return false;
          }, msg:'üîÇ N-gram repetition'},
        {name:'Sentiment Uniformity', key:'SentimentUniformity', test:function(t){return sentimentVariance(t.split(/\n+/).filter(function(p){return p.trim();}))<0.002;}, msg:'‚öñÔ∏è Uniform sentiment'},
        {name:'Hedge Words', key:'HedgeWords', test:function(t){return (t.match(/\b(possibly|potentially|arguably|perhaps|somewhat)\b/gi)||[]).length>3;}, msg:'üîç Hedge words'},
        {name:'Emoji Usage', key:'EmojiUsage', test:function(t){return (t.match(/[üòÄ-üôè]/g)||[]).length>1;}, msg:'üòä Emoji usage'},
        {name:'Complex Punctuation', key:'ComplexPunctuation', test:function(t){return (t.match(/[;:,]/g)||[]).length>5;}, msg:'‚úçÔ∏è Complex punctuation'}
      ];

      var reportData = {};

      // Analyze
      analyzeRun.onclick = function() {
        spinner.style.display = 'block';
        setTimeout(function() {
          spinner.style.display = 'none';
          var raw = document.getElementById('detectInput').value;
          var txt = normalizeText(raw);
          var ws = txt.split(/\s+/).filter(function(w){return w;});
          if (ws.length < 50) {
            results.textContent = 'Not enough data to judge.';
            return;
          }
          var strict = parseFloat(strictSlider.value);
          var score=0, msgs=[], facts=[];
          RULES.forEach(function(r){
            if (r.test(txt)) {
              var w = WEIGHTS[r.key]*strict;
              score += w; msgs.push(r.msg); facts.push({name:r.name,value:w});
            }
          });
          var finalScore = Math.min(10,score).toFixed(1);
          var likelihood = score>5?'High':'Moderate';
          reportData = {score:finalScore,likelihood,details:facts};
          results.innerHTML =
            '<strong>AI Match Score: '+finalScore+'/10</strong><br>' +
            '<strong>Likelihood:</strong> '+likelihood +
            '<ul><li>'+msgs.join('</li><li>')+'</li></ul>';
          // draw chart
          chart.clearRect(0,0,800,600);
          facts.forEach(function(f,i){
            chart.fillStyle='#4a90e2';
            chart.fillRect(200,i*40+20,f.value*40,25);
            chart.fillStyle='#000';
            chart.fillText(f.name+': '+f.value.toFixed(1),10,i*40+35);
          });
        },50);
      };

      detectClear.onclick = function() {
        document.getElementById('detectInput').value='';
        results.innerHTML='';
        chart.clearRect(0,0,800,600);
      };

      detectExport.onclick = function() {
        var blob=new Blob([JSON.stringify(reportData,null,2)],{type:'application/json'});
        var url=URL.createObjectURL(blob);
        var a=document.createElement('a');
        a.href=url; a.download='ai_report.json'; a.click(); URL.revokeObjectURL(url);
      };
    };
  </script>
</body>
</html>
